#!/usr/bin/env python3
"""
Hook script to run org hooks.

Modified from: https://stackoverflow.com/a/59055569
"""

import os
import shutil
import sys
from pathlib import Path

ORGHOOKS_DIR = Path(__file__).resolve().parent

MODERN_LINT_CONFIG_FILE = "pyproject.toml"
SEMGREP_RULES_DIR = "semgrep"


def copy_configs(dest_dir):
    """Override configurations for hooks"""
    dev_tools_dir = ORGHOOKS_DIR.parent
    lint_configs_dir = dev_tools_dir / "lint-configs"

    try:
        # Copy lint configs
        shutil.copyfile(
            lint_configs_dir / MODERN_LINT_CONFIG_FILE, dest_dir / MODERN_LINT_CONFIG_FILE
        )

        # Copy semgrep rules
        source_rules_dir = dev_tools_dir / SEMGREP_RULES_DIR
        dest_rules_dir = dest_dir / SEMGREP_RULES_DIR

        if source_rules_dir.exists():
            # Remove existing rules directory to ensure clean copy
            if dest_rules_dir.exists():
                shutil.rmtree(dest_rules_dir, ignore_errors=True)

            # Copy all files from source to destination
            shutil.copytree(source_rules_dir, dest_rules_dir)

    except Exception:
        # We can safely ignore these errors since the files are already there
        pass


def main():
    copy_configs(Path.cwd())
    cfg = str(ORGHOOKS_DIR / "orghooks.yaml")
    cmd = ["pre-commit", "run", "--config", cfg, "--files"] + sys.argv[1:]
    os.execvp(cmd[0], cmd)


if __name__ == "__main__":
    sys.exit(main())
